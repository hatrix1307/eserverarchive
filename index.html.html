<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Eagler Server List | Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<meta http-equiv="x-ua-compatible" content="ie=edge"/>
<meta name="twitter:card" content="summary"/>
<meta property="theme-color" content="#FB8464"/>
<link rel="icon" type="image/png" href="/eagler.png">
<link rel="shortcut icon" type="image/png" href="/eagler.png">

<link rel="preload" href="/_next/static/media/eafabf029ad39a43-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="/_next/static/media/8888a3826f4a3af4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="/_next/static/media/0484562807a97172-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="/_next/static/css/7b2b4dd7ecbe86d1.css">
<link rel="stylesheet" href="/_next/static/css/76289acd00d625c1.css">
<link rel="stylesheet" href="/_next/static/css/4d58c923eeda897e.css">
<link rel="stylesheet" href="/_next/static/css/dc7d422723254cb5.css">
<link rel="stylesheet" href="/_next/static/css/801a346d713e02de.css">
<link rel="stylesheet" href="/_next/static/css/2be4c86ae301c45c.css">
</head>
<body>
<div id="__next">
  <div>
    <main class="__className_cc80f9">
      <main class="Home_appContainer__0oIwU" style="opacity: 1;">

        <nav class="Navbar_root__hs6un">
          <div class="Navbar_logo__eioWt" style="cursor:pointer" onclick="location.href='/'">
            <img src="/eagler.png" alt="Logo">
            <h1>Eagler Server List</h1>
          </div>
          <div class="Navbar_spacer__t53No"></div>
          <ul class="Navbar_navElements__a5nON">
            <li class="Navbar_active__OcRhr"><a href="/">Home</a></li>
            <li><a href="/news">Site News</a></li>
          </ul>
        </nav>

        <div class="Home_homeRoot__D6YiM">
          <h1>Servers</h1>
          <p>View a list of available servers.</p>

          <div id="dynamic-server-container"></div>

          <div class="Home_pages__jwp2L" style="margin-top:20px;">
            <button id="btn-prev" disabled>Previous Page</button>
            <button id="btn-next">Next Page</button>
          </div>
        </div>

      </main>
    </main>
  </div>
</div>

<script>
let allPages = [];
let currentPage = 0;

function getDisplayAddress(addr) {
  return addr?.startsWith("wss://") ? addr : "wss://" + addr;
}

function getApiAddress(addr) {
  return addr?.replace(/^wss:\/\//, "").replace(/^ws:\/\//, "");
}

async function init() {
  try {
    const res = await fetch('./serverlistjson.txt');
    const text = await res.text();
    const chunks = text.split(/}\s*{/).map((str,i,arr) => {
      if (i===0) return str+"}";
      if (i===arr.length-1) return "{"+str;
      return "{"+str+"}";
    });
    chunks.forEach(s => {
      try { 
        const p = JSON.parse(s); 
        if (p.success && Array.isArray(p.data)) allPages.push(p.data); 
      } catch(e) {}
    });
    if (allPages.length>0) renderPage(0);
    document.getElementById('btn-prev').addEventListener('click', ()=>changePage(-1));
    document.getElementById('btn-next').addEventListener('click', ()=>changePage(1));
    setInterval(refreshCurrentPageStatus, 30000); // refresh every 30s
  } catch (e) {
    console.error("List load failed:", e);
  }
}

function changePage(dir) {
  const np = currentPage + dir;
  if (np>=0 && np<allPages.length) {
    currentPage = np;
    renderPage(np);
    window.scrollTo(0,0);
  }
}

// Helper to determine tag color (Now Case Insensitive)
function getTagColor(tagName) {
  // Convert tag to lowercase for comparison
  const t = tagName.trim().toLowerCase();
  
  const redTags = ["pvp", "pve", "factions", "prison"];
  
  if (redTags.includes(t)) return "#ff5252"; // Red
  if (t === "minigames") return "#ffeb3b";   // Yellow
  
  return "#46e393"; // Default Green
}

function renderPage(idx) {
  const container = document.getElementById('dynamic-server-container');
  container.innerHTML = "";
  allPages[idx].forEach(server => {
    const displayIP = getDisplayAddress(server.address);
    const apiAddr = getApiAddress(server.address);

    const card = document.createElement("div");
    card.className = "Server_box__TMsXv";
    card.dataset.apiAddress = apiAddr;
    card.style.cursor = "pointer";

    card.innerHTML = `
      <h2 style="overflow:hidden; margin-bottom: 4px; font-size: 1.6rem;">
        ${server.name} <div class="StatusIndicator_status__pidlp"></div>
      </h2>
      
      <div style="font-size: 1.1rem; color: #aaa; margin-bottom: 12px;">
         Votes: <span style="color:#46e393; font-weight:bold;">${server.votes}</span>
      </div>

      <div class="Server_tagListContainer__tAO2z">
        ${server.tags.map(tag => {
            const color = getTagColor(tag);
            return `<div class="Badge_inlineBadge__h8Mo1" style="color:${color}; font-size: 1rem; border-color:${color}40;">${tag}</div>`;
        }).join('')}
      </div>

      <div style="margin-top:10px;">
        <div>
          <h3 style="color:#fff; margin-bottom:4px; font-size: 1.2rem;">Address</h3>
          <span style="color:#FF8A65; font-weight:600; font-size: 1.1rem;">${displayIP}</span>
        </div>
      </div>
      
      <div class="status-meta" style="margin-top:6px; font-size:1rem; color:#ccc;"></div>
    `;

    card.addEventListener('click', () => {
      window.location.href = `/server.html?id=${server.uuid}`;
    });

    container.appendChild(card);
  });
  updateButtons();
  refreshCurrentPageStatus();
}

async function refreshCurrentPageStatus() {
  document.querySelectorAll('.Server_box__TMsXv').forEach(async (card) => {
    const apiAddr = card.dataset.apiAddress; 
    const dot = card.querySelector('.StatusIndicator_status__pidlp');
    const meta = card.querySelector('.status-meta');

    try {
      const res = await fetch(`/api/status/${encodeURIComponent(apiAddr)}`);
      const data = await res.json();  
      if (data && data.success && data.server && data.server.online) {
        dot.style.backgroundColor = "#4caf50";
        meta.textContent = `Players: ${data.server.players.online}/${data.server.players.max}`;
      } else {
        dot.style.backgroundColor = "#f44336";
        meta.textContent = "Offline";
      }
    } catch (error) {
      dot.style.backgroundColor = "#444";
      meta.textContent = "Status Error";
    }
  });
}

function updateButtons() {
  document.getElementById('btn-prev').disabled = (currentPage===0);
  document.getElementById('btn-next').disabled = (currentPage===allPages.length-1);
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
